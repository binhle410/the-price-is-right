<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="css/bootstrap.min.css"/>

    <!-- Optional theme -->
    <link rel="stylesheet" href="css/bootstrap-theme.min.css"/>

    <!-- Latest compiled and minified JavaScript -->
    <script src="js/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>

    <script src="js/jquery-ui.js"></script>

    <script src="js/jquery.formatter.min.js"></script>

    <script src="js/currencyFormatter.min.js"></script>

    <!-- http://www.jqueryscript.net/animation/jQuery-Plugin-To-Create-Canvas-Based-Fireworks.html -->
    <script src="js/jquery.fireworks.js"></script>

</head>
<body>
<!-- Fixed navbar -->
<nav class="navbar navbar-inverse">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar"
                    aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <!--<a class="navbar-brand" href="#">Sản phẩm</a>-->
        </div>
        <div id="navbar" class="navbar-collapse collapse">
            <ul id="menu_products" class="nav navbar-nav">
                z
                <!--<li class="dropdown">-->
                <!--<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true"-->
                <!--aria-expanded="false">Dropdown <span class="caret"></span></a>-->
                <!--<ul class="dropdown-menu">-->
                <!--<li class="active"><a href="#">Action</a></li>-->
                <!--<li><a href="#">Another action</a></li>-->
                <!--<li><a href="#">Something else here</a></li>-->
                <!--<li role="separator" class="divider"></li>-->
                <!--<li class="dropdown-header">Nav header</li>-->
                <!--<li><a href="#">Separated link</a></li>-->
                <!--<li><a href="#">One more separated link</a></li>-->
                <!--</ul>-->
                <!--</li>-->
            </ul>
        </div><!--/.nav-collapse -->
    </div>
</nav>


<div id="divContainer" class="container theme-showcase" role="main">
    <div class="row">
        <div class="col-xs-8 text-center">
            <div class="hidden">
                <audio id="audioPlayer"></audio>
            </div>
            <img id="product_image" width="100%" src="img/cover.jpg"/>
        </div>
        <div class="col-xs-4">
            <div class="row">
                <div class="col-xs-12">
                    <table width="100%" border="0px">
                        <tr>
                            <td style="padding-right: 5px;">
                                <input type="text" class="form-control" id="name"/>
                            </td>
                            <td style="padding-right: 5px;">
                                <input type="text" class="form-control" id="price"/>
                            </td>
                            <td>
                                <button class="btn btn-primary" id="check-btn">Kiểm tra</button>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <button class="hidden btn btn-default" id="btn-clear">Clear</button>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
            <div class="row">

            </div>
            <div class="row">
                <table class="table table-striped" id="guess-list">
                </table>
            </div>
        </div>
    </div>


</div> <!-- /container -->

<script>
    (function ($) {

        var products = [
            {
                'id': 1,
                'src': 'prod/01.jpg',
                'name': 'Giải Khuyến Khích',
                'active': false,
                'price': 3000,
                'parent': null,
                'hasChildren': true
            }
            ,
            {
                'id': 2,
                'src': 'prod/02.jpg',
                'name': 'Giải Ba',
                'active': false,
                'price': 6000,
                'parent': null,
                'hasChildren': true
            }
            ,
            {
                'id': 3,
                'src': 'prod/03.jpg',
                'name': 'Giải Nhì',
                'active': false,
                'price': 9000,
                'parent': null,
                'hasChildren': true
            }
            ,
            {
                'id': 4,
                'src': 'prod/giai-nhat.png',
                'name': 'Giải Nhất - Combo đặc biệt',
                'active': false,
                'price': 2205000,
                'parent': null,
                'hasChildren': false
            }
            ,
            {
                'id': 5,
                'src': 'prod/khuyen-khich/01.png',
                'name': 'Combo No bụng',
                'active': false,
                'price': 321600,
                'parent': 1,
                'hasChildren': false
            }
            ,
            {
                'id': 6,
                'src': 'prod/khuyen-khich/02.png',
                'name': 'Combo Thơm tho',
                'active': false,
                'price': 328000,
                'parent': 1,
                'hasChildren': false
            }
            ,
            {
                'id': 7,
                'src': 'prod/khuyen-khich/03.png',
                'name': 'Combo Gia vị',
                'active': false,
                'price': 310600,
                'parent': 1,
                'hasChildren': false
            }
            ,
            {
                'id': 8,
                'src': 'prod/khuyen-khich/04.png',
                'name': 'Combo Giặt giũ',
                'active': false,
                'price': 370000,
                'parent': 1,
                'hasChildren': false
            }
            ,
            {
                'id': 9,
                'src': 'prod/khuyen-khich/05.png',
                'name': 'Combo Bảo vệ da tay',
                'active': false,
                'price': 302900,
                'parent': 1,
                'hasChildren': false
            }
            ,
            {
                'id': 10,
                'src': 'prod/giai-ba/01.png',
                'name': 'Combo Phẳng phiu',
                'active': false,
                'price': 692900,
                'parent': 2,
                'hasChildren': false
            }
            ,
            {
                'id': 11,
                'src': 'prod/giai-ba/02.png',
                'name': 'Combo Siêu tốc',
                'active': false,
                'price': 763900,
                'parent': 2,
                'hasChildren': false
            }
            ,
            {
                'id': 13,
                'src': 'prod/giai-nhi/01.png',
                'name': 'Combo Chiên xào nấu',
                'active': false,
                'price': 811900,
                'parent': 3,
                'hasChildren': false
            }
            ,
            {
                'id': 14,
                'src': 'prod/giai-nhi/02.png',
                'name': 'Combo Bảo quản thức ăn',
                'active': false,
                'price': 1084000,
                'parent': 3,
                'hasChildren': false
            }
        ]

        var activeProduct = null;

        var $player = $('#audioPlayer');

        var audioElement = document.createElement('audio');

        $.each(products, function (i, _prod) {
            if (_prod.active == true) {
                activeClass = ' active '
                activeProduct = _prod;
                $('#product_image').attr('src', 'img/' + _prod.src);
            } else {
                activeClass = ''
            }
            if (_prod.hasChildren == false) {
                _itemClass = 'menu-item';
                _html = '<li id="menu_item_' + _prod.id + '"' + ' class = "menu-item ' + activeClass + '" ' + '><a href="#" id="product_' + _prod.id + '">' + _prod.name + '</a></li>';
            } else {
                _itemClass = 'dropdown menu-item';
                _html = '<li id="menu_item_' + _prod.id + '"' + ' class = "dropdown ' + activeClass + '" ' + '><a aria-expanded="false" role="button" aria-haspopup="true" data-toggle="dropdown" class="dropdown-toggle" href="#" id="product_' + _prod.id + '">' + _prod.name + '<span class="caret"></span></a>';
                _html += '<ul class="dropdown-menu" id="sub_menu_item_' + _prod.id + '">  ' + ' </ul> </li>';
            }
            console.log(_html);
            if (_prod.parent == null) {
                $('#menu_products').append(_html);
            } else {
                $('#sub_menu_item_' + _prod.parent).append(_html);
            }
            if (_prod.hasChildren == false) {
                $('#product_' + _prod.id).on('click', function () {

                    localStorage.setItem('guesser', JSON.stringify(new Array()));
                    $guessList.empty();

                    $.each(products, function (i, __prod) {
                        if (__prod.id == _prod.id) {
                            activeProduct = __prod;
                            $('#product_image').attr('src', 'img/' + __prod.src);
                            $('.menu-item').removeClass('active');
                            $('#menu_item_' + _prod.id).addClass(' active');
                            //                        $('#menu_item_' + _prod.id).attr('class', _itemClass + ' active');
                        }
                    });
                });
            }
        })

        var currencyFormatterParams =
            {
                currency: 'VND', 			// If currency is not supplied, defaults to USD
                symbol: 'k',			// Overrides the currency's default symbol
                locale: 'vi',			// Overrides the currency's default locale (see supported locales)
                decimal: ',',			// Overrides the locale's decimal character
                group: '.',			// Overrides the locale's group character (thousand separator)
                pattern: '#,###.'		// Overrides the locale's default display pattern

                // The pattern follows standard unicode currency pattern notation.
                // comma = group separator, dot = decimal separator, exclamation = currency symbol
            }

        var currencyFormatter = OSREC.CurrencyFormatter.getFormatter(currencyFormatterParams);

        formatMoney = function () {
            OSREC.CurrencyFormatter.formatAll(
                {
                    selector: '.money',

                });
        }
        var winner = null;
        findWinner = function (guesser) {
            _winner = null;
            _wonPrice = 0;
            $.each(guesser, function (i, _guess) {
                if (_guess.price <= activeProduct.price) {
                    if (_guess.price > _wonPrice) {
                        _wonPrice = _guess.price;
                        _winner = _guess;
                    }
                }
            })
            if (_wonPrice == 0) {
                return null;
                $.each(guesser, function (i, _guess) {
                    if (_guess.price > activeProduct.price) {
                        if (_wonPrice == 0) {
                            _wonPrice = _guess.price;
                            _winner = _guess;
                        }
                        if (_guess.price < _wonPrice) {
                            _wonPrice = _guess.price;
                            _winner = _guess;
                        }
                    }
                })
            }
            return _winner;
        }

//        $('#price').formatter({
//            'pattern': '{{999}},{{999}}',
//        });

        function dump(obj) {
            var out = '';
            for (var i in obj) {
                out += i + ": " + obj[i] + "\n";
            }

            alert(out);

            // or, if you wanted to avoid alerts...

            var pre = document.createElement('pre');
            pre.innerHTML = out;
            document.body.appendChild(pre)
        }

        appendGuess = function ($guessList, guess) {
            _html = '<tr id="' + guess.id + '"><td><h1 style="font-weight: bolder;">' + guess.name + ' - <span>' + currencyFormatter(guess.price) + '</span> ';
            _html += ' <button data-id="' + guess.id + '" id="button_' + guess.id + '"  type="button" class="btn btn-default" aria-label="Left Align"> <span class="glyphicon glyphicon-remove" aria-hidden="true"></span></button>';
            _html += '</h1>';
            _html += '</td></tr>';
            $guessList.prepend(_html);
            $('#button_' + guess.id).on('click', function () {
                $('#' + guess.id).hide();
                var guesser = JSON.parse(localStorage.getItem('guesser'));
                $.each(guesser, function (i, _guess) {
//                    console.log(i);
//                    console.log(guess);
                    if (guess.id == _guess.id) {
                        guesser.splice(i, 1);
                        localStorage.setItem('guesser', JSON.stringify(guesser));
                    }
                })

            });
        }

        /* ----------------------------------------------- */
        /* ----------------------------------------------- */
//        https://osrec.github.io/currencyFormatter.js/
        /* OnLoad Page */
        $(document).ready(function ($) {
            if (typeof(Storage) !== "undefined") {
                var guesser = JSON.parse(localStorage.getItem('guesser'));
                console.log(guesser);
                $guessList = $('#guess-list');
                if ($.isArray(guesser)) {

                } else {
                }
                $.each(guesser, function (i, guess) {
                    appendGuess($guessList, guess);
                })

            } else {
                // Sorry! No Web Storage support..
            }

            $('#myModal').on('hidden.bs.modal', function (e) {
                $('.modal-header').fireworks('destroy');
                $('body').fireworks('destroy');
            })

            $('#check-btn').click(function (e) {
                var guesser = JSON.parse(localStorage.getItem('guesser'));
                winner = findWinner(guesser);
//                alert(winner.name + '  ' + winner.price);
                if (winner == null) {
                    _noWinnerHTML = '';
                    _noWinnerHTML += '<h1><strong>THẬT ĐÁNG TIẾC</strong>. CẢ NHÀ MÌNH ĐI CHỢ HƠI QUÁ TAY RỒI !!! </h1>';
                    _noWinnerHTML += '';
                    $('#modal_body').html(_noWinnerHTML);
                    audioElement.setAttribute('src', 'mp3/fail' + Math.floor((Math.random() * 10) + 1) + '.mp3');
                    audioElement.play();
                } else {
                    _winnerHTML = '';
                    _winnerHTML += '<h1>XIN CHÚC MỪNG <strong>' + winner.name + '</strong> ĐÃ CHIẾN THẮNG VỚI GIÁ DỰ ĐOÁN: <strong>' + currencyFormatter(winner.price) + ' VNĐ</strong> </h1>';
                    _winnerHTML += '<h1>Sản phẩm có tổng giá trị là: <strong>' + currencyFormatter(activeProduct.price) + '</strong> VNĐ</h1>';
                    $('#modal_body').html(_winnerHTML);
                    audioElement.setAttribute('src', 'mp3/win' + Math.floor((Math.random() * 10) + 1) + '.mp3');
                    audioElement.play();
                    $('.modal-header').fireworks();
                    $('body').fireworks();
                }
                $('#myModal').modal('show');

            })

            $('#btn-clear').click(function (e) {
                localStorage.setItem('guesser', JSON.stringify(new Array()));
                $guessList.empty();
            })

            $('#name').keypress(function (e) {
                if (e.which == 13) {

                }
            });

            $('#price').keypress(function (e) {
                if (e.which == 13) {
                    var guesser = JSON.parse(localStorage.getItem('guesser'));
                    if (guesser == 'undefined' || guesser === null || guesser === 'null') {
                        guesser = new Array();
                        console.log('initiating a new array object for guesser');
                    }

                    var guess = new Object();
                    guess.name = $('#name').val();
                    guess.price = $('#price').val();
                    guess.id = Math.floor((Math.random() * 1000) + 1) + '_' + Math.floor((Math.random() * 1000) + 1) + '_' + Math.floor((Math.random() * 1000) + 1) + '_' + Math.floor((Math.random() * 1000) + 1);

                    guesser.push(guess);
                    localStorage.setItem('guesser', JSON.stringify(guesser));

                    $guessList = $('#guess-list');
                    appendGuess($guessList, guess);
                    $('#name').val('');
                    $('#price').val('');
                    $('#name').focus();
//                    formatMoney();
                }
            });
        });
        /* OnLoad Window */
        var init = function () {

        };
        window.onload = init;

    })(jQuery);

</script>

<div id="myModal" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span>
                </button>
                <h1 class="modal-title">KẾT QUẢ !</h1>
            </div>
            <div class="modal-body" id="modal_body">

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<script>

</script>
</body>
</html>